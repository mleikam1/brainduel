rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       Helper Functions
       ========================= */

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* =========================
       Trivia Question Bank
       ========================= */

    match /questions/{questionId} {
      allow read: if true;
      allow write: if false;
    }

    match /topics/{topicId} {
      allow read: if true;
      allow write: if false;
    }

    // Categories collection
    match /categories/{categoryId} {

      // Anyone can read categories
      allow read: if true;

      // No client writes to categories
      allow write: if false;

      // Questions subcollection
      match /questions/{questionId} {

        // Public read (standard for trivia apps)
        allow read: if true;

        // No client writes — backend/Admin SDK only
        allow write: if false;
      }
    }

    /* =========================
       User Data
       ========================= */

    match /users/{uid} {

      // Users can read/write their own user doc
      allow read, write: if isOwner(uid);

      // Allow direct access to the categoryProgress document path if requested.
      match /categoryProgress {
        allow read, write: if isOwner(uid);
      }

      // Per-category quiz progress
      match /categoryProgress/{categoryId} {

        allow read, write: if isOwner(uid);
      }
    }

    /* =========================
       Games
       ========================= */

    match /games/{gameId} {
      // Anonymous users can read game session payloads.
      allow read: if true;
      allow write: if false;

      match /players/{playerId} {
        allow read: if true;
        allow write: if false;
      }
    }

    /* =========================
       Shared Quizzes
       ========================= */

    match /sharedQuizzes/{quizId} {

      // Public read for deep links
      allow read: if true;

      // No client writes — backend/Admin SDK only
      allow write: if false;
    }
  }
}
