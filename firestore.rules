rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       Helper Functions
       ========================= */

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* =========================
       Trivia Question Bank
       ========================= */

    // Categories collection
    match /categories/{categoryId} {

      // Anyone can read categories
      allow read: if true;

      // No client writes to categories
      allow write: if false;

      // Questions subcollection
      match /questions/{questionId} {

        // Public read (standard for trivia apps)
        allow read: if true;

        // No client writes — backend/Admin SDK only
        allow write: if false;
      }
    }

    /* =========================
       User Data
       ========================= */

    match /users/{uid} {

      // Users can read/write their own user doc
      allow read, write: if isOwner(uid);

      // Per-category quiz progress
      match /categoryProgress/{categoryId} {

        allow read: if isOwner(uid);

        // Strict schema enforcement to prevent cost explosions
        allow create, update: if isOwner(uid)
          && request.resource.data.keys().hasOnly([
            "seed",
            "cursor",
            "exhaustedCount",
            "updatedAt",
            "weekKey"
          ])
          && request.resource.data.seed is string
          && request.resource.data.cursor is int
          && request.resource.data.exhaustedCount is int
          && request.resource.data.weekKey is string
          && request.resource.data.updatedAt is timestamp;

        allow delete: if isOwner(uid);
      }
    }

    /* =========================
       Shared Quizzes
       ========================= */

    match /sharedQuizzes/{quizId} {

      // Public read for deep links
      allow read: if true;

      // No client writes — backend/Admin SDK only
      allow write: if false;
    }
  }
}
